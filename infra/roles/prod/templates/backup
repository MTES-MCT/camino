#!/bin/bash
set eufo -pipefail

source /srv/scripts/restic_data

if [ "$(id -u)" != "{{git_user_uid}}" ]; then
   echo "This script must be run as git" 1>&2
   exit 1
fi
# backup

# ce dossier est directement monté dans le docker postgres à /dump
rm -rf /srv/backups/dump/*

docker exec camino_api_db vacuumlo camino
docker exec camino_api_db pg_dump --clean --if-exists --format=d --no-owner --no-privileges --dbname=camino -f /dump

# sauvegarde les fichiers
rsync --delete -r /srv/www/camino/files/  /srv/backups/files
chown git:users -R /srv/backups/

restic backup /srv/backups/