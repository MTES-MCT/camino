<?xml version="1.0" encoding="UTF-8" standalone="no"?><svg xmlns="http://www.w3.org/2000/svg" xmlns:xlink="http://www.w3.org/1999/xlink" contentStyleType="text/css" height="412px" preserveAspectRatio="none" style="width:548px;height:412px;background:#FFFFFF;" version="1.1" viewBox="0 0 548 412" width="548px" zoomAndPan="magnify"><defs/><g><line style="stroke:#181818;stroke-width:0.5;stroke-dasharray:5.0,5.0;" x1="28" x2="28" y1="36.2969" y2="376.7578"/><line style="stroke:#181818;stroke-width:0.5;stroke-dasharray:5.0,5.0;" x1="312.5" x2="312.5" y1="36.2969" y2="376.7578"/><line style="stroke:#181818;stroke-width:0.5;stroke-dasharray:5.0,5.0;" x1="411.5" x2="411.5" y1="36.2969" y2="376.7578"/><line style="stroke:#181818;stroke-width:0.5;stroke-dasharray:5.0,5.0;" x1="507.5" x2="507.5" y1="36.2969" y2="376.7578"/><rect fill="#E2E2F0" height="30.2969" rx="2.5" ry="2.5" style="stroke:#181818;stroke-width:0.5;" width="46" x="5" y="5"/><text fill="#000000" font-family="sans-serif" font-size="14" lengthAdjust="spacing" textLength="32" x="12" y="24.9951">User</text><rect fill="#E2E2F0" height="30.2969" rx="2.5" ry="2.5" style="stroke:#181818;stroke-width:0.5;" width="46" x="5" y="375.7578"/><text fill="#000000" font-family="sans-serif" font-size="14" lengthAdjust="spacing" textLength="32" x="12" y="395.7529">User</text><rect fill="#E2E2F0" height="30.2969" rx="2.5" ry="2.5" style="stroke:#181818;stroke-width:0.5;" width="75" x="275.5" y="5"/><text fill="#000000" font-family="sans-serif" font-size="14" lengthAdjust="spacing" textLength="61" x="282.5" y="24.9951">Keycloak</text><rect fill="#E2E2F0" height="30.2969" rx="2.5" ry="2.5" style="stroke:#181818;stroke-width:0.5;" width="75" x="275.5" y="375.7578"/><text fill="#000000" font-family="sans-serif" font-size="14" lengthAdjust="spacing" textLength="61" x="282.5" y="395.7529">Keycloak</text><rect fill="#E2E2F0" height="30.2969" rx="2.5" ry="2.5" style="stroke:#181818;stroke-width:0.5;" width="102" x="360.5" y="5"/><text fill="#000000" font-family="sans-serif" font-size="14" lengthAdjust="spacing" textLength="88" x="367.5" y="24.9951">Oauth2Proxy</text><rect fill="#E2E2F0" height="30.2969" rx="2.5" ry="2.5" style="stroke:#181818;stroke-width:0.5;" width="102" x="360.5" y="375.7578"/><text fill="#000000" font-family="sans-serif" font-size="14" lengthAdjust="spacing" textLength="88" x="367.5" y="395.7529">Oauth2Proxy</text><rect fill="#E2E2F0" height="30.2969" rx="2.5" ry="2.5" style="stroke:#181818;stroke-width:0.5;" width="70" x="472.5" y="5"/><text fill="#000000" font-family="sans-serif" font-size="14" lengthAdjust="spacing" textLength="56" x="479.5" y="24.9951">Website</text><rect fill="#E2E2F0" height="30.2969" rx="2.5" ry="2.5" style="stroke:#181818;stroke-width:0.5;" width="70" x="472.5" y="375.7578"/><text fill="#000000" font-family="sans-serif" font-size="14" lengthAdjust="spacing" textLength="56" x="479.5" y="395.7529">Website</text><polygon fill="#181818" points="301,63.4297,311,67.4297,301,71.4297,305,67.4297" style="stroke:#181818;stroke-width:1.0;"/><line style="stroke:#181818;stroke-width:1.0;" x1="28" x2="307" y1="67.4297" y2="67.4297"/><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacing" textLength="34" x="35" y="62.3638">Login</text><polygon fill="#181818" points="39,92.5625,29,96.5625,39,100.5625,35,96.5625" style="stroke:#181818;stroke-width:1.0;"/><line style="stroke:#181818;stroke-width:1.0;stroke-dasharray:2.0,2.0;" x1="33" x2="312" y1="96.5625" y2="96.5625"/><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacing" textLength="151" x="45" y="91.4966">Set credentials (cookie)</text><polygon fill="#181818" points="301,121.6953,311,125.6953,301,129.6953,305,125.6953" style="stroke:#181818;stroke-width:1.0;"/><line style="stroke:#181818;stroke-width:1.0;" x1="28" x2="307" y1="125.6953" y2="125.6953"/><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacing" textLength="113" x="35" y="120.6294">Impersonate user</text><polygon fill="#181818" points="39,150.8281,29,154.8281,39,158.8281,35,154.8281" style="stroke:#181818;stroke-width:1.0;"/><line style="stroke:#181818;stroke-width:1.0;stroke-dasharray:2.0,2.0;" x1="33" x2="312" y1="154.8281" y2="154.8281"/><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacing" textLength="212" x="45" y="149.7622">Set new user credentials (cookie)</text><polygon fill="#181818" points="399.5,179.9609,409.5,183.9609,399.5,187.9609,403.5,183.9609" style="stroke:#181818;stroke-width:1.0;"/><line style="stroke:#181818;stroke-width:1.0;" x1="28" x2="405.5" y1="183.9609" y2="183.9609"/><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacing" textLength="103" x="35" y="178.895">Go to sign_in url</text><polygon fill="#181818" points="39,209.0938,29,213.0938,39,217.0938,35,213.0938" style="stroke:#181818;stroke-width:1.0;"/><line style="stroke:#181818;stroke-width:1.0;stroke-dasharray:2.0,2.0;" x1="33" x2="410.5" y1="213.0938" y2="213.0938"/><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacing" textLength="231" x="45" y="208.0278">Redirect to keycloak openid-connect</text><polygon fill="#181818" points="301,238.2266,311,242.2266,301,246.2266,305,242.2266" style="stroke:#181818;stroke-width:1.0;"/><line style="stroke:#181818;stroke-width:1.0;" x1="28" x2="307" y1="242.2266" y2="242.2266"/><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacing" textLength="95" x="35" y="237.1606">Set cookie and</text><polygon fill="#181818" points="39,267.3594,29,271.3594,39,275.3594,35,271.3594" style="stroke:#181818;stroke-width:1.0;"/><line style="stroke:#181818;stroke-width:1.0;stroke-dasharray:2.0,2.0;" x1="33" x2="312" y1="271.3594" y2="271.3594"/><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacing" textLength="261" x="45" y="266.2935">redirect to oauth2_proxy oauth2/callback</text><polygon fill="#181818" points="399.5,296.4922,409.5,300.4922,399.5,304.4922,403.5,300.4922" style="stroke:#181818;stroke-width:1.0;"/><line style="stroke:#181818;stroke-width:1.0;" x1="28" x2="405.5" y1="300.4922" y2="300.4922"/><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacing" textLength="158" x="35" y="295.4263">Set oauth2_proxy cookie</text><polygon fill="#181818" points="39,325.625,29,329.625,39,333.625,35,329.625" style="stroke:#181818;stroke-width:1.0;"/><line style="stroke:#181818;stroke-width:1.0;stroke-dasharray:2.0,2.0;" x1="33" x2="410.5" y1="329.625" y2="329.625"/><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacing" textLength="205" x="45" y="324.5591">Redirect to the targeted website</text><polygon fill="#181818" points="495.5,354.7578,505.5,358.7578,495.5,362.7578,499.5,358.7578" style="stroke:#181818;stroke-width:1.0;"/><line style="stroke:#181818;stroke-width:1.0;" x1="28" x2="501.5" y1="358.7578" y2="358.7578"/><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacing" textLength="137" x="35" y="353.6919">access impersonated</text><!--MD5=[b03b0fb209ee13558d4c3ef6415cb4af]
@startuml
User -> Keycloak: Login
Keycloak - -> User: Set credentials (cookie)

User -> Keycloak: Impersonate user
Keycloak - -> User: Set new user credentials (cookie)

User -> Oauth2Proxy: Go to sign_in url
Oauth2Proxy - -> User: Redirect to keycloak openid-connect

User -> Keycloak: Set cookie and 
Keycloak - -> User: redirect to oauth2_proxy oauth2/callback

User -> Oauth2Proxy: Set oauth2_proxy cookie
Oauth2Proxy - -> User: Redirect to the targeted website

User -> Website: access impersonated
@enduml

PlantUML version 1.2022.3(Tue Mar 29 16:10:57 UTC 2022)
(GPL source distribution)
Java Runtime: OpenJDK Runtime Environment
JVM: OpenJDK 64-Bit Server VM
Default Encoding: ANSI_X3.4-1968
Language: en
Country: US
--></g></svg>