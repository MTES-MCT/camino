#https://github.com/fabriziocucci/vuejs.org/blob/7f9aa12833c085b97a826df3ba240f7d9e069e1b/src/v2/cookbook/dockerize-vuejs-app.md

FROM node:19.1-alpine as build-stage
LABEL maintainer=francois.romain@beta.gouv.fr
ARG GIT_SHA
ENV GIT_SHA=${GIT_SHA}
WORKDIR /app
RUN apk add make
COPY package*.json /app/
COPY packages/common/package.json /app/packages/common/package.json
COPY packages/ui/package.json /app/packages/ui/package.json
COPY Makefile /app/Makefile
RUN CI=true make install

COPY ./ /app/
RUN make build/ui

FROM node:19.1-alpine as production-stage

COPY --from=build-stage /app/package*.json ./
COPY --from=build-stage /app/packages/ui/package.json ./packages/ui/package.json
COPY Makefile /app/Makefile
RUN apk add make && cd /app && CI=true make install/prod
COPY --from=build-stage /app/packages/ui/dist ./packages/ui/dist
COPY --from=build-stage /app/packages/ui/index.js ./packages/ui/index.js

CMD ["make", "start/ui"]
